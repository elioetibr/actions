{"version":3,"file":"tools.mjs","sources":["../../../src/tools/common/runner-base.ts","../../../src/tools/common/iac-helpers.ts"],"sourcesContent":["import type { IAgent, IRunner, IRunnerResult } from '../../agents/interfaces';\n\n/**\n * Abstract base class for tool runners\n * Provides common functionality and enforces the runner contract\n */\nexport abstract class RunnerBase implements IRunner {\n  abstract readonly name: string;\n\n  /**\n   * Map of available steps and their implementations\n   */\n  protected abstract readonly steps: Map<string, (agent: IAgent) => Promise<IRunnerResult>>;\n\n  /**\n   * Run a specific step of the tool\n   * @param agent - The CI/CD agent\n   * @param step - The step to run\n   * @returns Promise with the runner result\n   */\n  async run(agent: IAgent, step: string): Promise<IRunnerResult> {\n    const stepFn = this.steps.get(step);\n\n    if (!stepFn) {\n      const availableSteps = Array.from(this.steps.keys()).join(', ');\n      const error = new Error(\n        `Unknown step '${step}' for runner '${this.name}'. Available steps: ${availableSteps}`,\n      );\n      return {\n        success: false,\n        outputs: {},\n        error,\n      };\n    }\n\n    try {\n      return await stepFn(agent);\n    } catch (error) {\n      return {\n        success: false,\n        outputs: {},\n        error: error instanceof Error ? error : new Error(String(error)),\n      };\n    }\n  }\n\n  /**\n   * Helper to create a successful result\n   * @param outputs - The outputs to include\n   */\n  protected success(outputs: Record<string, string | number | boolean>): IRunnerResult {\n    return {\n      success: true,\n      outputs,\n    };\n  }\n\n  /**\n   * Helper to create a failed result\n   * @param error - The error that caused the failure\n   * @param outputs - Optional partial outputs\n   */\n  protected failure(\n    error: Error | string,\n    outputs: Record<string, string | number | boolean> = {},\n  ): IRunnerResult {\n    return {\n      success: false,\n      outputs,\n      error: error instanceof Error ? error : new Error(error),\n    };\n  }\n}\n","import type { IAgent, IRunnerResult } from '../../agents/interfaces';\nimport type { IVersionResolver, IVersionInstaller, VersionSpec } from '../../libs/version-manager';\nimport type { IIacBuilder } from '../../actions/iac/common/interfaces';\nimport type { IIacService } from '../../actions/iac/common/interfaces';\n\n/**\n * Shared settings common to both Terraform and Terragrunt runners.\n * Captures the 17 fields that appear identically in both ITerraformSettings\n * and ITerragruntSettings.\n */\nexport interface ISharedIacSettings {\n  readonly command: string;\n  readonly workingDirectory: string;\n  readonly variables: Record<string, string>;\n  readonly varFiles: string[];\n  readonly backendConfig: Record<string, string>;\n  readonly targets: string[];\n  readonly autoApprove: boolean;\n  readonly planFile: string;\n  readonly noColor: boolean;\n  readonly compactWarnings: boolean;\n  readonly parallelism: string;\n  readonly lockTimeout: string;\n  readonly refresh: string;\n  readonly reconfigure: boolean;\n  readonly migrateState: boolean;\n  readonly dryRun: boolean;\n}\n\n/**\n * Resolve and optionally install a tool version.\n * When the resolver returns undefined (i.e. 'skip'), the runner uses\n * whatever binary is already on PATH.\n */\nexport async function setupToolVersion(\n  agent: IAgent,\n  toolName: string,\n  version: string,\n  versionFile: string,\n  workingDirectory: string,\n  resolver: IVersionResolver,\n  installer: IVersionInstaller,\n): Promise<void> {\n  agent.startGroup(`${toolName} version setup`);\n  try {\n    const spec: VersionSpec | undefined = await resolver.resolve(\n      version,\n      versionFile,\n      workingDirectory,\n    );\n\n    if (!spec) {\n      agent.info(`${toolName} version: skip (using existing PATH binary)`);\n      return;\n    }\n\n    agent.info(`${toolName} version: ${spec.resolved} (source: ${spec.source})`);\n\n    const cacheDir = await installer.install(spec.resolved, agent);\n    agent.addPath(cacheDir);\n  } finally {\n    agent.endGroup();\n  }\n}\n\n/**\n * Apply the 17 shared settings to an IaC builder.\n * Returns the builder for continued chaining.\n */\nexport function configureSharedIacBuilder<T extends IIacBuilder<IIacService>>(\n  builder: T,\n  settings: ISharedIacSettings,\n): T {\n  if (Object.keys(settings.variables).length > 0) {\n    builder.withVariables(settings.variables);\n  }\n  if (settings.varFiles.length > 0) {\n    builder.withVarFiles(settings.varFiles);\n  }\n  if (Object.keys(settings.backendConfig).length > 0) {\n    builder.withBackendConfigs(settings.backendConfig);\n  }\n  if (settings.targets.length > 0) {\n    builder.withTargets(settings.targets);\n  }\n  if (settings.autoApprove) {\n    builder.withAutoApprove();\n  }\n  if (settings.planFile) {\n    if (settings.command === 'apply') {\n      builder.withPlanFile(settings.planFile);\n    } else if (settings.command === 'plan') {\n      builder.withOutFile(settings.planFile);\n    }\n  }\n  if (settings.noColor) {\n    builder.withNoColor();\n  }\n  if (settings.compactWarnings) {\n    builder.withCompactWarnings();\n  }\n  if (settings.parallelism) {\n    const value = parseInt(settings.parallelism, 10);\n    if (!isNaN(value)) {\n      builder.withParallelism(value);\n    }\n  }\n  if (settings.lockTimeout) {\n    builder.withLockTimeout(settings.lockTimeout);\n  }\n  if (settings.refresh === 'false') {\n    builder.withoutRefresh();\n  }\n  if (settings.reconfigure) {\n    builder.withReconfigure();\n  }\n  if (settings.migrateState) {\n    builder.withMigrateState();\n  }\n  if (settings.dryRun) {\n    builder.withDryRun();\n  }\n\n  return builder;\n}\n\n/**\n * Run an IaC command through the agent.\n * Shared flow: build command → log → dry-run check → agent.run → exit code.\n *\n * NOTE: This calls agent.exec() — the IAgent interface method that\n * delegates to @actions/exec (execFile under the hood), NOT child_process.\n */\nexport async function executeIacCommand(\n  agent: IAgent,\n  toolLabel: string,\n  service: { buildCommand(): string[]; toString(): string },\n  settings: { command: string; workingDirectory: string; dryRun: boolean },\n  successFn: (outputs: Record<string, string | number | boolean>) => IRunnerResult,\n  failureFn: (error: Error, outputs?: Record<string, string | number | boolean>) => IRunnerResult,\n): Promise<IRunnerResult> {\n  const commandArgs = service.buildCommand();\n  const commandString = service.toString();\n\n  agent.info(`Command: ${commandString}`);\n\n  const baseOutputs: Record<string, string | number | boolean> = {\n    command: settings.command,\n    'command-args': JSON.stringify(commandArgs),\n    'command-string': commandString,\n  };\n\n  if (settings.dryRun) {\n    agent.info('Dry run mode - skipping execution');\n    return successFn({\n      ...baseOutputs,\n      'exit-code': '0',\n      stdout: '',\n      stderr: '',\n    });\n  }\n\n  const [cmd, ...cmdArgs] = commandArgs;\n  if (!cmd) {\n    return failureFn(new Error(`${toolLabel} produced an empty command`));\n  }\n\n  // Safe: IAgent wraps @actions/exec internally\n  const result = await agent.exec(cmd, cmdArgs, {\n    cwd: settings.workingDirectory,\n    ignoreReturnCode: true,\n  });\n\n  const outputs = {\n    ...baseOutputs,\n    'exit-code': result.exitCode.toString(),\n    stdout: result.stdout,\n    stderr: result.stderr,\n  };\n\n  if (result.exitCode !== 0) {\n    return failureFn(new Error(`${toolLabel} failed with exit code ${result.exitCode}`), outputs);\n  }\n\n  return successFn(outputs);\n}\n"],"names":[],"mappings":"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"}